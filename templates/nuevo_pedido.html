{% extends "base.html" %}
{% block title %}Nuevo Pedido{% endblock %}

{% block content %}
<h1 class="mb-4">Nuevo Pedido</h1>

<form method="POST" action="{{ url_for('pedidos.nuevo') }}">

  <!-- Cliente / Fecha -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <label class="form-label">Cliente</label>
      <select name="id_cliente" class="form-select bg-dark text-light" required>
        <option value="" disabled selected>Elegir…</option>
        {% for c in clientes %}
          <option value="{{ c[0] }}">{{ c[1] }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">Fecha de entrega</label>
      <input type="date" name="fecha_entrega" class="form-control bg-dark text-light" required>
    </div>
  </div>

  <!-- Producto -->
  <div class="mb-4">
    <h4 class="mb-3">Agregar Producto</h4>

    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Producto</label>
        <select id="selProducto" class="form-select bg-dark text-light" required>
          <option value="" disabled selected>Elegir…</option>
          {% for p in productos %}
            <option
              value="{{ p[0] }}"
              data-desc="{{ p[1] }}"
              data-precio="{{ "%.2f"|format(p[2]) }}"
              data-unidad="{{ p[3] }}"
            >
              {{ p[1] }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Cantidad</label>
        <input id="inpCantidad" type="number" min="1"
               class="form-control bg-dark text-light" required>
      </div>

      <div class="col-md-2">
        <label class="form-label">Unidad</label>
        <span id="inpUnidad" class="form-control bg-dark text-light fw-bold"
              style="height:38px;display:flex;align-items:center;"></span>
      </div>

      <div class="col-md-2">
        <label class="form-label">Precio ($)</label>
        <input id="inpPrecio" type="number" step="0.01"
               class="form-control bg-dark text-light" required>
      </div>

      <div class="col-md-2 d-grid">
        <button type="button" id="btnAddLinea" class="btn btn-primary">
          <i class="bi bi-plus-lg me-1"></i>Añadir
        </button>
      </div>
    </div>
  </div>

  <!-- Detalle -->
  <table class="table table-dark table-bordered align-middle" id="tabla-detalle">
    <thead class="table-secondary text-dark">
      <tr>
        <th style="width:40%">Producto</th>
        <th style="width:15%">Cant.</th>
        <th style="width:15%">Unidad</th>
        <th style="width:20%">Precio</th>
        <th style="width:10%"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="mt-3 text-end fs-5">
    <strong>Total: $<span id="totalGeneral">0.00</span></strong>
  </div>

  <div class="mt-4 text-end">
    <button type="submit" class="btn btn-success btn-lg">
      <i class="bi bi-save2 me-1"></i>Guardar Pedido
    </button>
  </div>

  <!-- Fila plantilla -->
  <template id="fila-template">
    <tr>
      <td>
        <input type="hidden" name="id_producto">
        <span class="nombre"></span>
      </td>
      <td>
        <input type="number" name="cantidad" class="form-control bg-dark text-light"
               min="1" required>
      </td>
      <td>
        <input type="hidden" name="unidad">
        <span class="unidad-base fw-bold"></span>
      </td>
      <td>
        <input type="number" step="0.01" name="precio"
               class="form-control bg-dark text-light" required>
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-danger eliminar" title="Eliminar">
          <i class="bi bi-x-lg"></i>
        </button>
      </td>
    </tr>
  </template>
</form>
{% endblock %}

{% block scripts %}
{{ super() }}  {# conserva los scripts comunes de base.html #}

<script>
/* Todo el JS espera a que el DOM esté listo */
document.addEventListener('DOMContentLoaded', () => {

  /* ► Referencias a nodos */
  const selProd   = document.getElementById('selProducto');
  const cantInput = document.getElementById('inpCantidad');
  const unidadLbl = document.getElementById('inpUnidad');
  const precioInp = document.getElementById('inpPrecio');
  const tabla     = document.querySelector('#tabla-detalle tbody');
  const tpl       = document.getElementById('fila-template').content;
  const addBtn    = document.getElementById('btnAddLinea');
  const totalLbl  = document.getElementById('totalGeneral');

  /* ► Completar precio y unidad al seleccionar producto */
  selProd.addEventListener('change', () => {
    const opt = selProd.selectedOptions[0];
    if (!opt) return;               // opción “Elegir…”
    unidadLbl.textContent = opt.dataset.unidad || '';
    precioInp.value       = opt.dataset.precio || '';
  });

  /* ► Añadir línea a la tabla */
  addBtn.addEventListener('click', () => {
    const opt  = selProd.selectedOptions[0];
    const cant = Number(cantInput.value);
    const prec = Number(precioInp.value);

    if (!opt || !opt.value || cant < 1 || prec <= 0) {
      alert('Completá producto, cantidad (>0) y precio (>0)');
      return;
    }

    const fila = tpl.cloneNode(true);
    fila.querySelector('input[name="id_producto"]').value  = opt.value;
    fila.querySelector('.nombre').textContent              = opt.dataset.desc;
    fila.querySelector('input[name="cantidad"]').value     = cant;
    fila.querySelector('input[name="unidad"]').value       = unidadLbl.textContent;
    fila.querySelector('.unidad-base').textContent         = unidadLbl.textContent;
    fila.querySelector('input[name="precio"]').value       = prec.toFixed(2);
    tabla.appendChild(fila);

    /* limpiar formulario de producto */
    selProd.selectedIndex = 0;
    cantInput.value = '';
    unidadLbl.textContent = '';
    precioInp.value = '';

    actualizarTotal();
  });

  /* ► Quitar línea */
  tabla.addEventListener('click', e => {
    if (e.target.closest('button.eliminar')) {
      e.target.closest('tr').remove();
      actualizarTotal();
    }
  });

  /* ► Recalcular total */
  function actualizarTotal() {
    let total = 0;
    tabla.querySelectorAll('tr').forEach(tr => {
      const p = parseFloat(tr.querySelector('input[name="precio"]').value)   || 0;
      const c = parseFloat(tr.querySelector('input[name="cantidad"]').value) || 0;
      total += p * c;
    });
    totalLbl.textContent = total.toFixed(2);
  }

});
</script>
{% endblock %}
