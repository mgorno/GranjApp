{% extends "base.html" %} {% block title %}Confirmar Cantidades{% endblock %} {%
block head_extra %} {{ super() }}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/confirmar_remito.css') }}"
/>
<script src="{{ url_for('static', filename='js/remito.js') }}" defer></script>

{% endblock %} {% block content %}
<h1 class="mb-4 text-white border-bottom pb-2" style="font-weight: 500">
  <i class="bi bi-clipboard-check me-2 text-warning"></i>Confirmar Cantidades
</h1>
<div class="mb-4 text-white">
  <p class="mb-1"><strong>Cliente:</strong> {{ cliente_nombre }}</p>
  <p class="mb-1">
    <strong>Fecha de entrega:</strong> {{ fecha_entrega.strftime('%d/%m/%Y') }}
  </p>
</div>
<form
  action="{{ url_for('entregas.remito', id_pedido=id_pedido) }}"
  method="POST"
  id="form-remito"
  data-saldo-anterior="{{ '%.2f'|format(saldo_anterior) }}"
>
  <!-- Tabla de productos -->
  <div class="table-responsive mb-4">
    <table
      class="table table-dark table-bordered align-middle"
      id="tabla-remito"
    >
      <thead class="table-secondary text-dark">
        <tr>
          <th style="width: 30%">Producto</th>
          <th style="width: 10%" class="text-end">Cant. Pedida</th>
          <th style="width: 10%" class="text-end">Precio</th>
          <th style="width: 10%" class="text-end">Cant. Ajustada</th>
          <th style="width: 10%" class="text-end">Subtotal</th>
          <th style="width: 5%"></th>
        </tr>
      </thead>
      <tbody>
        {% for item in detalles %}
        <tr>
          <td>
            {{ item.descripcion }} ({{ item.unidad_base }})
            <input
              type="hidden"
              name="id_producto[]"
              value="{{ item.id_producto }}"
            />
            <input
              type="hidden"
              name="id_detalle[]"
              value="{{ item.id_detalle }}"
            />
          </td>

          <td class="text-end">{{ item.cantidad | formato_cantidad }}</td>

          <td class="text-end">
            <input
              type="number"
              step="0.01"
              name="precio[]"
              value="{{ (item.precio or 0) | formato_precio_sin_signo }}"
              class="form-control text-end bg-dark text-light border-secondary table-input precio-input"
              required
            />
          </td>

          <td class="text-end">
            <input
              type="number"
              step="0.01"
              name="cantidad_real[]"
              value="{{ (item.cantidad_real or 0)|float }}"
              class="form-control text-end bg-dark text-light border-secondary table-input cantidad-input"
              required
            />
          </td>

          <td class="text-end subtotal-cell">
            {{ ((item.precio or 0) * (item.cantidad_real or 0)) | formato_precio
            }}
          </td>

          <td class="text-center">
            {% if item.id_detalle|string == "0" %}
            <button
              type="button"
              class="btn btn-outline-danger btn-sm eliminar-fila"
              title="Eliminar fila"
            >
              <i class="bi bi-trash"></i>
            </button>
            {% else %}
            <i
              class="bi bi-lock-fill text-secondary"
              title="No se puede eliminar"
            ></i>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <hr class="my-4" />

    <h5 class="text-white mb-3">Agregar nuevo producto</h5>

    <div class="row g-2 align-items-center mb-3">
      <div class="col-8 col-md-6">
        <select
          name="nuevo_id_producto"
          class="form-select form-select-sm"
          aria-label="Seleccionar producto nuevo"
        >
          <option value="" selected>-- Seleccionar producto --</option>
          {% for p in productos %}
          <option value="{{ p.id_producto }}">
            {{ p.descripcion }} ({{ p.unidad_base }})
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-4 col-md-2">
        <input
          type="number"
          name="nuevo_cantidad"
          min="0.01"
          step="0.01"
          class="form-control form-control-sm"
          placeholder="Cantidad"
        />
      </div>
      <div class="col-12 col-md-4">
        <button
          type="submit"
          name="accion"
          value="agregar"
          class="btn btn-sm btn-outline-success"
        >
          <i class="bi bi-plus-circle me-1"></i>Agregar producto
        </button>
      </div>
    </div>
  </div>

  <!-- Resumen de totales -->
  <div class="row g-3 mb-4">
    <div class="col-md-4 ms-auto">
      <div class="card bg-dark text-white border-secondary">
        <div class="card-body">
          <p class="d-flex justify-content-between mb-2">
            <span>Total remito:</span>
            <strong id="total-remito">0</strong>
          </p>
          <p class="d-flex justify-content-between mb-2">
            <span>Saldo anterior:</span>
            <strong>{{ saldo_anterior | formato_precio_arg }}</strong>
          </p>
          <p class="d-flex justify-content-between mb-2">
            <span>Saldo total:</span>
            <strong id="saldo-total">0</strong>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones -->
  <div class="d-flex gap-2">
    <a
      href="{{ url_for('entregas.lista_entregas') }}"
      class="btn btn-secondary"
    >
      <i class="bi bi-arrow-left me-1"></i>Volver
    </a>
    {% if remitos.fecha_entrega == fecha_hoy %}
    <button
      type="submit"
      name="accion"
      value="confirmar"
      class="btn btn-success"
    >
      <i class="bi bi-check2-circle me-1"></i>Generar Remito
    </button>
    {% endif %}
  </div>
</form>
{% endblock %}
